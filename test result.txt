[root]
AiServiceTest
testServiceCreation()
testAskWithLanguageMethodExists()
testGenerateComprehensionTestWithLanguageMethodExists()
testGenerateComprehensionTestMethodExists()
testAskMethodExists()
SummaryControllerTest
testPagesSummary_InvalidRange()
testGeneralSummary_Success()
testGeneralSummary_EnglishOutput()
testOutputLanguageOverridesBookLanguage()
testPagesSummary_EnglishOutput()
testPagesSummary_Success()
testControllerCreation()
testLanguageFallbackToBookLanguage()
testGeneralSummary_NoBook()
FileParserServiceTest
testParsePdf_FileNamePreserved()
testServiceCreation()
testParsePdf_PageNumbersAreSequential()
testParseEmptyFile()
testParsePdf_FullTextContainsAllPages()
testParseNullFile()
testParseValidPdf()
testParsePdfWithMultiplePages()
testParsePdf_LargeFile()
testParseInvalidPdf()
QaControllerTest
BookAssistantLiteIntegrationTests
testRealityCheckEndpoint()
testActionPlanEndpoint()
testOutputLanguageEnglish()
testOutputLanguageArabic()
testConceptMapEndpoint()
testRiskFlagsEndpoint()
testSemanticSearchEndpoint()
testGeneralSummaryEndpoint()
testPagesSummaryEndpoint()
testHomePageLoads()
testLanguageDetectionArabic()
testFileUploadInvalidType()
contextLoads()
testQaEndpoint()
testFileUpload()
testLanguageDetectionEnglish()
testComprehensionEndpoint()
BookSessionTest
testExtractRange_InvalidRange()
testLanguageDetection_EmptyContent()
testInitialSessionState()
testClearSession()
testLanguageDetection_ArabicContent()
testLanguageDetection_LargeText()
testExtractRange_SinglePage()
testExtractRange_NoBook()
testLanguageDetection_MixedContentMoreArabic()
testSetBookAndGetBook()
testLanguageDetection_EnglishContent()
testExtractRange()

C:\Users\Meena\.jdks\openjdk-25.0.2\bin\java.exe -javaagent:C:\Users\Meena\AppData\Local\JetBrains\IntelliJIdea2025.3\captureAgent\debugger-agent.jar=file:///C:/Users/Meena/AppData/Local/Temp/capture5406093119883367161.props -ea -Didea.test.cyclic.buffer.size=1048576 "-javaagent:C:\Program Files\JetBrains\IntelliJ IDEA 2025.3.2\lib\idea_rt.jar=57427" -Dkotlinx.coroutines.debug.enable.creation.stack.trace=false -Ddebugger.agent.enable.coroutines=true -Dkotlinx.coroutines.debug.enable.flows.stack.trace=true -Dkotlinx.coroutines.debug.enable.mutable.state.flows.stack.trace=true -Ddebugger.async.stack.trace.for.all.threads=true -Dfile.encoding=UTF-8 -Dsun.stdout.encoding=UTF-8 -Dsun.stderr.encoding=UTF-8 -classpath "C:\Users\Meena\.m2\repository\org\junit\platform\junit-platform-launcher\1.12.2\junit-platform-launcher-1.12.2.jar;C:\Program Files\JetBrains\IntelliJ IDEA 2025.3.2\lib\idea_rt.jar;C:\Program Files\JetBrains\IntelliJ IDEA 2025.3.2\plugins\junit\lib\junit6-rt.jar;C:\Program Files\JetBrains\IntelliJ IDEA 2025.3.2\plugins\junit\lib\junit5-rt.jar;C:\Program Files\JetBrains\IntelliJ IDEA 2025.3.2\plugins\junit\lib\junit-rt.jar;C:\Users\Meena\book-assistant-lite\target\test-classes;C:\Users\Meena\book-assistant-lite\target\classes;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-starter-web\3.5.0\spring-boot-starter-web-3.5.0.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-starter\3.5.0\spring-boot-starter-3.5.0.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot\3.5.0\spring-boot-3.5.0.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-autoconfigure\3.5.0\spring-boot-autoconfigure-3.5.0.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-starter-logging\3.5.0\spring-boot-starter-logging-3.5.0.jar;C:\Users\Meena\.m2\repository\ch\qos\logback\logback-classic\1.5.18\logback-classic-1.5.18.jar;C:\Users\Meena\.m2\repository\ch\qos\logback\logback-core\1.5.18\logback-core-1.5.18.jar;C:\Users\Meena\.m2\repository\org\apache\logging\log4j\log4j-to-slf4j\2.24.3\log4j-to-slf4j-2.24.3.jar;C:\Users\Meena\.m2\repository\org\apache\logging\log4j\log4j-api\2.24.3\log4j-api-2.24.3.jar;C:\Users\Meena\.m2\repository\org\slf4j\jul-to-slf4j\2.0.17\jul-to-slf4j-2.0.17.jar;C:\Users\Meena\.m2\repository\jakarta\annotation\jakarta.annotation-api\2.1.1\jakarta.annotation-api-2.1.1.jar;C:\Users\Meena\.m2\repository\org\yaml\snakeyaml\2.4\snakeyaml-2.4.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-starter-json\3.5.0\spring-boot-starter-json-3.5.0.jar;C:\Users\Meena\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jdk8\2.19.0\jackson-datatype-jdk8-2.19.0.jar;C:\Users\Meena\.m2\repository\com\fasterxml\jackson\datatype\jackson-datatype-jsr310\2.19.0\jackson-datatype-jsr310-2.19.0.jar;C:\Users\Meena\.m2\repository\com\fasterxml\jackson\module\jackson-module-parameter-names\2.19.0\jackson-module-parameter-names-2.19.0.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-starter-tomcat\3.5.0\spring-boot-starter-tomcat-3.5.0.jar;C:\Users\Meena\.m2\repository\org\apache\tomcat\embed\tomcat-embed-core\10.1.41\tomcat-embed-core-10.1.41.jar;C:\Users\Meena\.m2\repository\org\apache\tomcat\embed\tomcat-embed-el\10.1.41\tomcat-embed-el-10.1.41.jar;C:\Users\Meena\.m2\repository\org\apache\tomcat\embed\tomcat-embed-websocket\10.1.41\tomcat-embed-websocket-10.1.41.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-web\6.2.7\spring-web-6.2.7.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-beans\6.2.7\spring-beans-6.2.7.jar;C:\Users\Meena\.m2\repository\io\micrometer\micrometer-observation\1.15.0\micrometer-observation-1.15.0.jar;C:\Users\Meena\.m2\repository\io\micrometer\micrometer-commons\1.15.0\micrometer-commons-1.15.0.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-webmvc\6.2.7\spring-webmvc-6.2.7.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-aop\6.2.7\spring-aop-6.2.7.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-context\6.2.7\spring-context-6.2.7.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-expression\6.2.7\spring-expression-6.2.7.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-starter-thymeleaf\3.5.0\spring-boot-starter-thymeleaf-3.5.0.jar;C:\Users\Meena\.m2\repository\org\thymeleaf\thymeleaf-spring6\3.1.3.RELEASE\thymeleaf-spring6-3.1.3.RELEASE.jar;C:\Users\Meena\.m2\repository\org\thymeleaf\thymeleaf\3.1.3.RELEASE\thymeleaf-3.1.3.RELEASE.jar;C:\Users\Meena\.m2\repository\org\attoparser\attoparser\2.0.7.RELEASE\attoparser-2.0.7.RELEASE.jar;C:\Users\Meena\.m2\repository\org\unbescape\unbescape\1.1.6.RELEASE\unbescape-1.1.6.RELEASE.jar;C:\Users\Meena\.m2\repository\org\slf4j\slf4j-api\2.0.17\slf4j-api-2.0.17.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-starter-test\3.5.0\spring-boot-starter-test-3.5.0.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-test\3.5.0\spring-boot-test-3.5.0.jar;C:\Users\Meena\.m2\repository\org\springframework\boot\spring-boot-test-autoconfigure\3.5.0\spring-boot-test-autoconfigure-3.5.0.jar;C:\Users\Meena\.m2\repository\com\jayway\jsonpath\json-path\2.9.0\json-path-2.9.0.jar;C:\Users\Meena\.m2\repository\jakarta\xml\bind\jakarta.xml.bind-api\4.0.2\jakarta.xml.bind-api-4.0.2.jar;C:\Users\Meena\.m2\repository\jakarta\activation\jakarta.activation-api\2.1.3\jakarta.activation-api-2.1.3.jar;C:\Users\Meena\.m2\repository\net\minidev\json-smart\2.5.2\json-smart-2.5.2.jar;C:\Users\Meena\.m2\repository\net\minidev\accessors-smart\2.5.2\accessors-smart-2.5.2.jar;C:\Users\Meena\.m2\repository\org\ow2\asm\asm\9.7.1\asm-9.7.1.jar;C:\Users\Meena\.m2\repository\org\assertj\assertj-core\3.27.3\assertj-core-3.27.3.jar;C:\Users\Meena\.m2\repository\net\bytebuddy\byte-buddy\1.17.5\byte-buddy-1.17.5.jar;C:\Users\Meena\.m2\repository\org\awaitility\awaitility\4.3.0\awaitility-4.3.0.jar;C:\Users\Meena\.m2\repository\org\hamcrest\hamcrest\3.0\hamcrest-3.0.jar;C:\Users\Meena\.m2\repository\org\junit\jupiter\junit-jupiter\5.12.2\junit-jupiter-5.12.2.jar;C:\Users\Meena\.m2\repository\org\junit\jupiter\junit-jupiter-api\5.12.2\junit-jupiter-api-5.12.2.jar;C:\Users\Meena\.m2\repository\org\opentest4j\opentest4j\1.3.0\opentest4j-1.3.0.jar;C:\Users\Meena\.m2\repository\org\junit\platform\junit-platform-commons\1.12.2\junit-platform-commons-1.12.2.jar;C:\Users\Meena\.m2\repository\org\apiguardian\apiguardian-api\1.1.2\apiguardian-api-1.1.2.jar;C:\Users\Meena\.m2\repository\org\junit\jupiter\junit-jupiter-params\5.12.2\junit-jupiter-params-5.12.2.jar;C:\Users\Meena\.m2\repository\org\junit\jupiter\junit-jupiter-engine\5.12.2\junit-jupiter-engine-5.12.2.jar;C:\Users\Meena\.m2\repository\org\junit\platform\junit-platform-engine\1.12.2\junit-platform-engine-1.12.2.jar;C:\Users\Meena\.m2\repository\org\mockito\mockito-core\5.17.0\mockito-core-5.17.0.jar;C:\Users\Meena\.m2\repository\net\bytebuddy\byte-buddy-agent\1.17.5\byte-buddy-agent-1.17.5.jar;C:\Users\Meena\.m2\repository\org\objenesis\objenesis\3.3\objenesis-3.3.jar;C:\Users\Meena\.m2\repository\org\mockito\mockito-junit-jupiter\5.17.0\mockito-junit-jupiter-5.17.0.jar;C:\Users\Meena\.m2\repository\org\skyscreamer\jsonassert\1.5.3\jsonassert-1.5.3.jar;C:\Users\Meena\.m2\repository\com\vaadin\external\google\android-json\0.0.20131108.vaadin1\android-json-0.0.20131108.vaadin1.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-core\6.2.7\spring-core-6.2.7.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-jcl\6.2.7\spring-jcl-6.2.7.jar;C:\Users\Meena\.m2\repository\org\springframework\spring-test\6.2.7\spring-test-6.2.7.jar;C:\Users\Meena\.m2\repository\org\xmlunit\xmlunit-core\2.10.1\xmlunit-core-2.10.1.jar;C:\Users\Meena\.m2\repository\org\apache\pdfbox\pdfbox\3.0.4\pdfbox-3.0.4.jar;C:\Users\Meena\.m2\repository\org\apache\pdfbox\pdfbox-io\3.0.4\pdfbox-io-3.0.4.jar;C:\Users\Meena\.m2\repository\org\apache\pdfbox\fontbox\3.0.4\fontbox-3.0.4.jar;C:\Users\Meena\.m2\repository\commons-logging\commons-logging\1.3.4\commons-logging-1.3.4.jar;C:\Users\Meena\.m2\repository\com\fasterxml\jackson\core\jackson-databind\2.19.0\jackson-databind-2.19.0.jar;C:\Users\Meena\.m2\repository\com\fasterxml\jackson\core\jackson-annotations\2.19.0\jackson-annotations-2.19.0.jar;C:\Users\Meena\.m2\repository\com\fasterxml\jackson\core\jackson-core\2.19.0\jackson-core-2.19.0.jar" com.intellij.rt.junit.JUnitStarter -ideVersion5 -junit5 @w@C:\Users\Meena\AppData\Local\Temp\idea_working_dirs_junit.tmp @C:\Users\Meena\AppData\Local\Temp\idea_junit.tmp -socket57426
Mockito is currently self-attaching to enable the inline-mock-maker. This will no longer work in future releases of the JDK. Please add Mockito as an agent to your build as described in Mockito's documentation: https://javadoc.io/doc/org.mockito/mockito-core/latest/org.mockito/org/mockito/Mockito.html#0.3
WARNING: A Java agent has been loaded dynamically (C:\Users\Meena\.m2\repository\net\bytebuddy\byte-buddy-agent\1.17.5\byte-buddy-agent-1.17.5.jar)
WARNING: If a serviceability tool is in use, please run with -XX:+EnableDynamicAgentLoading to hide this warning
WARNING: If a serviceability tool is not in use, please run with -Djdk.instrument.traceUsage for more information
WARNING: Dynamic loading of agents will be disallowed by default in a future release
OpenJDK 64-Bit Server VM warning: Sharing is only supported for boot loader classes because bootstrap classpath has been appended
09:09:00.257 [main] INFO com.bookassistant.service.AiService -- Calling AI API at: null
09:09:00.261 [main] INFO com.bookassistant.service.AiService -- Timeout set to: 0 seconds
09:09:00.547 [main] ERROR com.bookassistant.service.AiService -- Unexpected error calling AI API
java.lang.IllegalArgumentException: URI with undefined scheme
	at java.net.http/jdk.internal.net.http.common.Utils.newIAE(Utils.java:394)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.checkURI(HttpRequestBuilderImpl.java:81)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:73)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:45)
	at com.bookassistant.service.AiService.call(AiService.java:102)
	at com.bookassistant.service.AiService.ask(AiService.java:69)
	at com.bookassistant.service.AiServiceTest.lambda$testAskWithLanguageMethodExists$0(AiServiceTest.java:58)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:49)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:36)
	at org.junit.jupiter.api.Assertions.assertDoesNotThrow(Assertions.java:3199)
	at com.bookassistant.service.AiServiceTest.testAskWithLanguageMethodExists(AiServiceTest.java:57)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:104)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:775)
	at org.junit.platform.commons.support.ReflectionSupport.invokeMethod(ReflectionSupport.java:479)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:161)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:152)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:91)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:112)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:94)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:87)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:216)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:212)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:137)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:156)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:201)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:170)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:94)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:59)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:142)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.InterceptingLauncher.lambda$execute$1(InterceptingLauncher.java:39)
	at org.junit.platform.launcher.core.ClasspathAlignmentCheckingLauncherInterceptor.intercept(ClasspathAlignmentCheckingLauncherInterceptor.java:25)
	at org.junit.platform.launcher.core.InterceptingLauncher.execute(InterceptingLauncher.java:38)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.SessionPerRequestLauncher.execute(SessionPerRequestLauncher.java:63)
	at com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:66)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)
	at com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:237)
	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)
09:09:00.562 [main] INFO com.bookassistant.service.AiService -- Calling AI API at: null
09:09:00.563 [main] INFO com.bookassistant.service.AiService -- Timeout set to: 0 seconds
09:09:00.568 [main] ERROR com.bookassistant.service.AiService -- Unexpected error calling AI API
java.lang.IllegalArgumentException: URI with undefined scheme
	at java.net.http/jdk.internal.net.http.common.Utils.newIAE(Utils.java:394)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.checkURI(HttpRequestBuilderImpl.java:81)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:73)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:45)
	at com.bookassistant.service.AiService.call(AiService.java:102)
	at com.bookassistant.service.AiService.ask(AiService.java:69)
	at com.bookassistant.service.AiService.generateComprehensionTest(AiService.java:86)
	at com.bookassistant.service.AiServiceTest.lambda$testGenerateComprehensionTestWithLanguageMethodExists$0(AiServiceTest.java:74)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:49)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:36)
	at org.junit.jupiter.api.Assertions.assertDoesNotThrow(Assertions.java:3199)
	at com.bookassistant.service.AiServiceTest.testGenerateComprehensionTestWithLanguageMethodExists(AiServiceTest.java:73)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:104)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:775)
	at org.junit.platform.commons.support.ReflectionSupport.invokeMethod(ReflectionSupport.java:479)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:161)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:152)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:91)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:112)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:94)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:87)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:216)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:212)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:137)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:156)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:201)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:170)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:94)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:59)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:142)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.InterceptingLauncher.lambda$execute$1(InterceptingLauncher.java:39)
	at org.junit.platform.launcher.core.ClasspathAlignmentCheckingLauncherInterceptor.intercept(ClasspathAlignmentCheckingLauncherInterceptor.java:25)
	at org.junit.platform.launcher.core.InterceptingLauncher.execute(InterceptingLauncher.java:38)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.SessionPerRequestLauncher.execute(SessionPerRequestLauncher.java:63)
	at com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:66)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)
	at com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:237)
	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)
09:09:00.579 [main] INFO com.bookassistant.service.AiService -- Calling AI API at: null
09:09:00.579 [main] INFO com.bookassistant.service.AiService -- Timeout set to: 0 seconds
09:09:00.582 [main] ERROR com.bookassistant.service.AiService -- Unexpected error calling AI API
java.lang.IllegalArgumentException: URI with undefined scheme
	at java.net.http/jdk.internal.net.http.common.Utils.newIAE(Utils.java:394)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.checkURI(HttpRequestBuilderImpl.java:81)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:73)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:45)
	at com.bookassistant.service.AiService.call(AiService.java:102)
	at com.bookassistant.service.AiService.ask(AiService.java:50)
	at com.bookassistant.service.AiService.generateComprehensionTest(AiService.java:75)
	at com.bookassistant.service.AiServiceTest.lambda$testGenerateComprehensionTestMethodExists$0(AiServiceTest.java:66)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:49)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:36)
	at org.junit.jupiter.api.Assertions.assertDoesNotThrow(Assertions.java:3199)
	at com.bookassistant.service.AiServiceTest.testGenerateComprehensionTestMethodExists(AiServiceTest.java:65)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:104)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:775)
	at org.junit.platform.commons.support.ReflectionSupport.invokeMethod(ReflectionSupport.java:479)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:161)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:152)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:91)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:112)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:94)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:87)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:216)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:212)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:137)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:156)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:201)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:170)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:94)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:59)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:142)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.InterceptingLauncher.lambda$execute$1(InterceptingLauncher.java:39)
	at org.junit.platform.launcher.core.ClasspathAlignmentCheckingLauncherInterceptor.intercept(ClasspathAlignmentCheckingLauncherInterceptor.java:25)
	at org.junit.platform.launcher.core.InterceptingLauncher.execute(InterceptingLauncher.java:38)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.SessionPerRequestLauncher.execute(SessionPerRequestLauncher.java:63)
	at com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:66)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)
	at com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:237)
	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)
09:09:00.590 [main] INFO com.bookassistant.service.AiService -- Calling AI API at: null
09:09:00.590 [main] INFO com.bookassistant.service.AiService -- Timeout set to: 0 seconds
09:09:00.594 [main] ERROR com.bookassistant.service.AiService -- Unexpected error calling AI API
java.lang.IllegalArgumentException: URI with undefined scheme
	at java.net.http/jdk.internal.net.http.common.Utils.newIAE(Utils.java:394)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.checkURI(HttpRequestBuilderImpl.java:81)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:73)
	at java.net.http/jdk.internal.net.http.HttpRequestBuilderImpl.uri(HttpRequestBuilderImpl.java:45)
	at com.bookassistant.service.AiService.call(AiService.java:102)
	at com.bookassistant.service.AiService.ask(AiService.java:50)
	at com.bookassistant.service.AiServiceTest.lambda$testAskMethodExists$0(AiServiceTest.java:50)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:49)
	at org.junit.jupiter.api.AssertDoesNotThrow.assertDoesNotThrow(AssertDoesNotThrow.java:36)
	at org.junit.jupiter.api.Assertions.assertDoesNotThrow(Assertions.java:3199)
	at com.bookassistant.service.AiServiceTest.testAskMethodExists(AiServiceTest.java:48)
	at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:104)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:775)
	at org.junit.platform.commons.support.ReflectionSupport.invokeMethod(ReflectionSupport.java:479)
	at org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)
	at org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:161)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:152)
	at org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:91)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:112)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:94)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)
	at org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:93)
	at org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:87)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:216)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:212)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:137)
	at org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:69)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:156)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:160)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:146)
	at org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:144)
	at org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:143)
	at org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:100)
	at org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)
	at org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:201)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:170)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:94)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:59)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:142)
	at org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:58)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:103)
	at org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:85)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.InterceptingLauncher.lambda$execute$1(InterceptingLauncher.java:39)
	at org.junit.platform.launcher.core.ClasspathAlignmentCheckingLauncherInterceptor.intercept(ClasspathAlignmentCheckingLauncherInterceptor.java:25)
	at org.junit.platform.launcher.core.InterceptingLauncher.execute(InterceptingLauncher.java:38)
	at org.junit.platform.launcher.core.DelegatingLauncher.execute(DelegatingLauncher.java:47)
	at org.junit.platform.launcher.core.SessionPerRequestLauncher.execute(SessionPerRequestLauncher.java:63)
	at com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:66)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)
	at com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)
	at com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)
	at com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:237)
	at com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:58)

org.mockito.exceptions.misusing.UnnecessaryStubbingException: 
Unnecessary stubbings detected.
Clean & maintainable test code requires zero unnecessary code.
Following stubbings are unnecessary (click to navigate to relevant line of code):
  1. -> at com.bookassistant.controller.SummaryControllerTest.setUp(SummaryControllerTest.java:51)
Please remove unnecessary stubbings or use 'lenient' strictness. More info: javadoc for UnnecessaryStubbingException class.

	at org.mockito.junit.jupiter.MockitoExtension.lambda$afterEach$2(MockitoExtension.java:200)
	at java.base/java.util.Optional.ifPresent(Optional.java:178)
	at org.mockito.junit.jupiter.MockitoExtension.afterEach(MockitoExtension.java:198)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)


org.mockito.exceptions.misusing.UnnecessaryStubbingException: 
Unnecessary stubbings detected.
Clean & maintainable test code requires zero unnecessary code.
Following stubbings are unnecessary (click to navigate to relevant line of code):
  1. -> at com.bookassistant.controller.QaControllerTest.setUp(QaControllerTest.java:50)
Please remove unnecessary stubbings or use 'lenient' strictness. More info: javadoc for UnnecessaryStubbingException class.

	at org.mockito.junit.jupiter.MockitoExtension.lambda$afterEach$2(MockitoExtension.java:200)
	at java.base/java.util.Optional.ifPresent(Optional.java:178)
	at org.mockito.junit.jupiter.MockitoExtension.afterEach(MockitoExtension.java:198)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

09:09:01.536 [main] INFO org.springframework.test.context.support.AnnotationConfigContextLoaderUtils -- Could not detect default configuration classes for test class [com.bookassistant.BookAssistantLiteIntegrationTests]: BookAssistantLiteIntegrationTests does not declare any static, non-private, non-final, nested classes annotated with @Configuration.
09:09:01.696 [main] INFO org.springframework.boot.test.context.SpringBootTestContextBootstrapper -- Found @SpringBootConfiguration com.bookassistant.BookAssistantLiteApplication for test class com.bookassistant.BookAssistantLiteIntegrationTests

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/

 :: Spring Boot ::                (v3.5.0)

2026-02-24T09:09:02.286+02:00  INFO 27504 --- [book-assistant-lite] [           main] c.b.BookAssistantLiteIntegrationTests    : Starting BookAssistantLiteIntegrationTests using Java 25.0.2 with PID 27504 (started by Meena in C:\Users\Meena\book-assistant-lite)
2026-02-24T09:09:02.287+02:00  INFO 27504 --- [book-assistant-lite] [           main] c.b.BookAssistantLiteIntegrationTests    : No active profile set, falling back to 1 default profile: "default"
2026-02-24T09:09:03.859+02:00  INFO 27504 --- [book-assistant-lite] [           main] c.b.BookAssistantLiteIntegrationTests    : Started BookAssistantLiteIntegrationTests in 1.957 seconds (process running for 6.297)
2026-02-24T09:09:04.335+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:09:04.336+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:09:04.339+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:09:16.270+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@4777f71e}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /reality-check
       Parameters = {startPage=[1], endPage=[2], outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@61375dff}

Handler:
             Type = com.bookassistant.controller.AnalysisController
           Method = com.bookassistant.controller.AnalysisController#realityCheck(int, int, String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = realityCheck
            value =         .             

       :
-    
-    
-    
-      

       .
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testRealityCheckEndpoint(BookAssistantLiteIntegrationTests.java:244)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:09:16.345+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:09:16.345+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:09:16.348+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:09:49.306+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@59509393}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /action-plan
       Parameters = {startPage=[1], endPage=[2], outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@1d6dc2b8}

Handler:
             Type = com.bookassistant.controller.PlanController
           Method = com.bookassistant.controller.PlanController#actionPlan(int, int, String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = actionPlan
            value =              .

                    :

-  
-  
-  
-  
-   

        .
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testActionPlanEndpoint(BookAssistantLiteIntegrationTests.java:329)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:09:49.341+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:09:49.341+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:09:49.342+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:09:53.948+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200
2026-02-24T09:09:53.964+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:09:53.964+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:09:53.966+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:09:57.162+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200
2026-02-24T09:09:57.211+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:09:57.212+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:09:57.218+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:10:26.281+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@7af7c9aa}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /concept-map
       Parameters = {startPage=[1], endPage=[2], outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@208b8425}

Handler:
             Type = com.bookassistant.controller.AnalysisController
           Method = com.bookassistant.controller.AnalysisController#conceptMap(int, int, String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = conceptMap
            value =           . 

     :
-     
-   
-     

                     .
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testConceptMapEndpoint(BookAssistantLiteIntegrationTests.java:273)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:10:26.316+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:10:26.316+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:10:26.318+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:10:31.634+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@5f69462f}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /risk-flags
       Parameters = {outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@432b883}

Handler:
             Type = com.bookassistant.controller.AnalysisController
           Method = com.bookassistant.controller.AnalysisController#riskFlags(String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = riskFlags
            value =               . 

              mentioned .

    
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testRiskFlagsEndpoint(BookAssistantLiteIntegrationTests.java:300)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:10:31.668+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:10:31.669+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:10:31.671+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:10:55.272+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@3a61d819}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /semantic-search
       Parameters = {query=[main concepts], outputLanguage=[en]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@386ea60f}

Handler:
             Type = com.bookassistant.controller.SearchController
           Method = com.bookassistant.controller.SearchController#semanticSearch(String, String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = semanticSearch
            value = I don't see any text provided in your message. You've only included the query "main concepts" but there's no actual text content for me to analyze and extract main concepts from.

Could you please provide the text you'd like me to examine? Once you share the text, I'll be happy to identify and explain the main concepts contained within it.
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testSemanticSearchEndpoint(BookAssistantLiteIntegrationTests.java:215)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:10:55.307+02:00  WARN 27504 --- [book-assistant-lite] [           main] org.apache.pdfbox.pdfparser.COSParser    : The end of the stream doesn't point to the correct offset, using workaround to read the stream, stream start position: 234, length: 44, expected end position: 278
2026-02-24T09:10:55.337+02:00  WARN 27504 --- [book-assistant-lite] [           main] o.a.p.c.operator.text.SetFontAndSize     : font 'F1' not found in resources
2026-02-24T09:10:55.338+02:00  WARN 27504 --- [book-assistant-lite] [           main] o.a.p.contentstream.PDFStreamEngine      : No current font, will use default
2026-02-24T09:10:55.586+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:10:55.586+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:10:55.588+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:11:05.108+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@799557c8}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /summary/general
       Parameters = {outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@42d96745}

Handler:
             Type = com.bookassistant.controller.SummaryController
           Method = com.bookassistant.controller.SummaryController#generalSummary(String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = summaryGeneral
            value =          . 

                 .
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testGeneralSummaryEndpoint(BookAssistantLiteIntegrationTests.java:130)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:11:05.141+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:11:05.141+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:11:05.143+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:11:12.069+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@3e574f9c}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /summary/pages
       Parameters = {startPage=[1], endPage=[2], outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@5cfa9e8a}

Handler:
             Type = com.bookassistant.controller.SummaryController
           Method = com.bookassistant.controller.SummaryController#pagesSummary(int, int, String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = summaryPages
            value =          . 

               .
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testPagesSummaryEndpoint(BookAssistantLiteIntegrationTests.java:159)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:11:12.188+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:11:12.188+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:11:12.193+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:11:46.992+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@27caa186}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /qa
       Parameters = {question=[What is this book about?], outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@6ebf9c2d}

Handler:
             Type = com.bookassistant.controller.QaController
           Method = com.bookassistant.controller.QaController#qa(String, String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = qa
            value =         .                      .

            
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testQaEndpoint(BookAssistantLiteIntegrationTests.java:187)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)

2026-02-24T09:11:47.016+02:00  WARN 27504 --- [book-assistant-lite] [           main] org.apache.pdfbox.pdfparser.COSParser    : The end of the stream doesn't point to the correct offset, using workaround to read the stream, stream start position: 234, length: 44, expected end position: 278
2026-02-24T09:11:47.017+02:00  WARN 27504 --- [book-assistant-lite] [           main] o.a.p.c.operator.text.SetFontAndSize     : font 'F1' not found in resources
2026-02-24T09:11:47.017+02:00  WARN 27504 --- [book-assistant-lite] [           main] o.a.p.contentstream.PDFStreamEngine      : No current font, will use default
2026-02-24T09:11:47.043+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Calling AI API at: https://ollama.com
2026-02-24T09:11:47.043+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Timeout set to: 300 seconds
2026-02-24T09:11:47.045+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Sending request to Ollama Cloud...
2026-02-24T09:11:54.674+02:00  INFO 27504 --- [book-assistant-lite] [           main] com.bookassistant.service.AiService      : Response status: 200

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /upload
       Parameters = {}
          Headers = [Content-Type:"multipart/form-data;charset=UTF-8"]
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@5c20841d}

Handler:
             Type = com.bookassistant.controller.UploadController
           Method = com.bookassistant.controller.UploadController#upload(MultipartFile, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = hasBook
            value = true
        Attribute = success
            value =    

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status">
                    <span class="status-dot"></span>
                    <span class="status-text">English Book Loaded</span>
                    <span class="lang-badge">English</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card has-book">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span>Book Loaded</span>
                </h2>
                <p class="subtitle">You can now use analysis tools</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">Click to change file</p>
                        <p class="drop-subtext">PDF  200MB</p>
                        <div class="file-info">
                            <span class="file-icon"></span>
                            <span>Language detected: English</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">Re-upload</button>
            </form>

            

            <div class="alert alert-success">
                <span class="alert-icon"></span>
                <span>   </span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card">
            <div class="lang-header">
                <h3>
                    <span class="icon"></span>
                    <span>Language Settings</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label>Detected Book Language</label>
                    <span class="lang-badge">English</span>
                </div>
                <div class="lang-option">
                    <label>Output Language</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" selected="selected"></option>
                        <option value="en">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Summaries</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary"></span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>General Summary</span></h4>
                        </div>
                        <form action="/summary/general" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Summary</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            
                            <p class="no-result">Click button to generate summary</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Selected Pages Summary</span></h4>
                        </div>
                        <form action="/summary/pages" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Summarize</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            
                            <p class="no-result">Enter page range and click Summarize</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Analysis</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis"></span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Reality Check</span></h4>
                        </div>
                        <form action="/reality-check" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Check</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            
                            <p class="no-result">Enter page range and click Check</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Concept Map</span></h4>
                        </div>
                        <form action="/concept-map" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Map</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            
                            <p class="no-result">Enter page range and click Generate Map</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Risk Flags</span></h4>
                        </div>
                        <form action="/risk-flags" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span>Extract Flags</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            
                            <p class="no-result">Click to extract risk flags</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon"></span>
                        <h3>Interactive</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive"></span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Action Plan</span></h4>
                        </div>
                        <form action="/action-plan" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Plan</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            
                            <p class="no-result">Enter page range and click Generate Plan</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Semantic Search</span></h4>
                        </div>
                        <form action="/semantic-search" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>What are you looking for?</label>
                                    <input type="text" name="query" required placeholder="Type your search...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Search</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            
                            <p class="no-result">Type your query and click Search</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Question &amp; Answer</span></h4>
                        </div>
                        <form action="/qa" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label>Ask about the book</label>
                                    <input type="text" name="question" required placeholder="Type your question...">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Send</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            
                            <p class="no-result">Type your question and click Send</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4> <span>Comprehension Test</span></h4>
                        </div>
                        <form action="/comprehension" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>From Page</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label>To Page</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span>Generate Test</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            
                            <p class="no-result">Enter page range and click Generate Test</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite - AI Powered</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

MockHttpServletRequest:
      HTTP Method = POST
      Request URI = /comprehension
       Parameters = {startPage=[1], endPage=[2], outputLanguage=[ar]}
          Headers = []
             Body = null
    Session Attrs = {scopedTarget.bookSession=com.bookassistant.session.BookSession@1a1dd8eb}

Handler:
             Type = com.bookassistant.controller.ComprehensionController
           Method = com.bookassistant.controller.ComprehensionController#comprehension(int, int, String, Model)

Async:
    Async started = false
     Async result = null

Resolved Exception:
             Type = null

ModelAndView:
        View name = index
             View = null
        Attribute = comprehension
            value =         1  2   .                   .

    1-2         :

     (      distracteurs)
   
    

        .
        Attribute = hasBook
            value = false
        Attribute = bookLanguage
            value = ar

FlashMap:
       Attributes = null

MockHttpServletResponse:
           Status = 200
    Error message = null
          Headers = [Content-Language:"en", Content-Type:"text/html;charset=UTF-8"]
     Content type = text/html;charset=UTF-8
             Body = <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"></span>
                    <h1>Book Assistant Lite</h1>
                </div>
                
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card">
            <div class="upload-header">
                <h2>
                    <span class="icon"></span>
                    <span> </span>
                </h2>
                <p class="subtitle">PDF  200MB</p>
            </div>

            <form action="/upload" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon"></div>
                        <p class="drop-text">   PDF   </p>
                        <p class="drop-subtext">PDF  200MB</p>
                        
                    </div>
                </div>
                <button type="submit" class="btn btn-primary"></button>
            </form>

            

            
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>Book Assistant Lite -   </p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span> ...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>

    Forwarded URL = null
   Redirected URL = null
          Cookies = []

java.lang.AssertionError: Model attribute 'hasBook' expected:<true> but was:<false>
Expected :true
Actual   :false
<Click to see difference>


	at org.springframework.test.util.AssertionErrors.fail(AssertionErrors.java:61)
	at org.springframework.test.util.AssertionErrors.assertEquals(AssertionErrors.java:128)
	at org.springframework.test.web.servlet.result.ModelResultMatchers.lambda$attribute$1(ModelResultMatchers.java:74)
	at org.springframework.test.web.servlet.MockMvc$1.andExpect(MockMvc.java:214)
	at com.bookassistant.BookAssistantLiteIntegrationTests.testComprehensionEndpoint(BookAssistantLiteIntegrationTests.java:358)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)


org.opentest4j.AssertionFailedError: 
Expected :ar
Actual   :en
<Click to see difference>


	at org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:151)
	at org.junit.jupiter.api.AssertionFailureBuilder.buildAndThrow(AssertionFailureBuilder.java:132)
	at org.junit.jupiter.api.AssertEquals.failNotEqual(AssertEquals.java:197)
	at org.junit.jupiter.api.AssertEquals.assertEquals(AssertEquals.java:182)
	at org.junit.jupiter.api.AssertEquals.assertEquals(AssertEquals.java:177)
	at org.junit.jupiter.api.Assertions.assertEquals(Assertions.java:1145)
	at com.bookassistant.service.BookSessionTest.testLanguageDetection_MixedContentMoreArabic(BookSessionTest.java:93)
	at java.base/java.lang.reflect.Method.invoke(Method.java:565)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)
	at java.base/java.util.ArrayList.forEach(ArrayList.java:1604)


Process finished with exit code -1

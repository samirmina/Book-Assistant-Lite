<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:lang="${bookLanguage != null ? bookLanguage : 'ar'}"
      th:dir="${bookLanguage != null && bookLanguage == 'en' ? 'ltr' : 'rtl'}"
      lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Assistant Lite - AI Book Analysis</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Highlight.js for syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    
    <link rel="stylesheet" th:href="@{/styles.css}">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon">ğŸ“š</span>
                    <h1>Book Assistant Lite</h1>
                </div>
                <div class="book-status" th:if="${hasBook}">
                    <span class="status-dot"></span>
                    <span class="status-text" th:text="${bookLanguage == 'ar' ? 'ÙƒØªØ§Ø¨ Ø¹Ø±Ø¨ÙŠ Ù…Ø­Ù…Ù‘Ù„' : 'English Book Loaded'}">ÙƒØªØ§Ø¨ Ù…Ø­Ù…Ù‘Ù„</span>
                    <span class="lang-badge" th:text="${bookLanguage == 'ar' ? 'Ø¹Ø±Ø¨ÙŠ' : 'English'}">Ø¹Ø±Ø¨ÙŠ</span>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <section class="upload-section card" th:classappend="${hasBook} ? 'has-book' : ''">
            <div class="upload-header">
                <h2>
                    <span class="icon">ğŸ“¤</span>
                    <span th:text="${hasBook} ? (${bookLanguage == 'ar' ? 'Ø§Ù„ÙƒØªØ§Ø¨ Ù…Ø­Ù…Ù‘Ù„' : 'Book Loaded'}) : 'Ø±ÙØ¹ Ø§Ù„ÙƒØªØ§Ø¨'">Ø±ÙØ¹ Ø§Ù„ÙƒØªØ§Ø¨</span>
                </h2>
                <p class="subtitle" th:text="${hasBook} ? (${bookLanguage == 'ar' ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ù„ÙŠÙ„' : 'You can now use analysis tools'}) : 'PDF Ø­ØªÙ‰ 200MB'">PDF Ø­ØªÙ‰ 200MB</p>
            </div>

            <form th:action="@{/upload}" method="post" enctype="multipart/form-data" class="upload-form">
                <div class="drop-zone" id="dropZone">
                    <input type="file" name="file" accept="application/pdf" id="fileInput" required>
                    <div class="drop-zone-content">
                        <div class="drop-icon">ğŸ“„</div>
                        <p class="drop-text" th:text="${hasBook} ? (${bookLanguage == 'ar' ? 'Ø§Ø¶ØºØ· Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ù„Ù' : 'Click to change file'}) : 'Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ Ù‡Ù†Ø§'">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù PDF Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡ Ù‡Ù†Ø§</p>
                        <p class="drop-subtext">PDF Ø­ØªÙ‰ 200MB</p>
                        <div class="file-info" th:if="${hasBook}">
                            <span class="file-icon">âœ…</span>
                            <span th:text="${bookLanguage == 'ar' ? 'ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ©: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'Language detected: English'}">ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ©: Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" th:text="${hasBook} ? (${bookLanguage == 'ar' ? 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ÙØ¹' : 'Re-upload'}) : 'Ø±ÙØ¹'">Ø±ÙØ¹</button>
            </form>

            <div th:if="${error}" class="alert alert-error">
                <span class="alert-icon">âš ï¸</span>
                <span th:text="${error}">Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù</span>
            </div>

            <div th:if="${success}" class="alert alert-success">
                <span class="alert-icon">âœ…</span>
                <span th:text="${success}">ØªÙ… Ø§Ù„Ø±ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­</span>
            </div>
        </section>

        <!-- Language Settings - Only shown when book is loaded -->
        <section class="lang-section card" th:if="${hasBook}">
            <div class="lang-header">
                <h3>
                    <span class="icon">ğŸŒ</span>
                    <span th:text="${bookLanguage == 'ar' ? 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©' : 'Language Settings'}">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„ØºØ©</span>
                </h3>
            </div>
            <div class="lang-controls">
                <div class="lang-option">
                    <label th:text="${bookLanguage == 'ar' ? 'Ù„ØºØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…ÙƒØªØ´ÙØ©' : 'Detected Book Language'}">Ù„ØºØ© Ø§Ù„ÙƒØªØ§Ø¨ Ø§Ù„Ù…ÙƒØªØ´ÙØ©</label>
                    <span class="lang-badge" th:text="${bookLanguage == 'ar' ? 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©' : 'English'}">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</span>
                </div>
                <div class="lang-option">
                    <label th:text="${bookLanguage == 'ar' ? 'Ù„ØºØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©' : 'Output Language'}">Ù„ØºØ© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</label>
                    <select name="outputLanguage" id="outputLanguage" class="lang-select">
                        <option value="ar" th:selected="${bookLanguage == 'ar' || bookLanguage == null}">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="en" th:selected="${bookLanguage == 'en'}">English</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Analysis Tools Accordion - Only shown when book is loaded -->
        <div class="accordion-container" th:if="${hasBook}">
            
            <!-- Group 1: Summary -->
            <div class="accordion-group" data-group="summary">
                <div class="accordion-header" onclick="toggleAccordion('summary')">
                    <div class="accordion-title">
                        <span class="accordion-icon">ğŸ“–</span>
                        <h3 th:text="${bookLanguage == 'ar' ? 'Ø§Ù„Ù…Ù„Ø®ØµØ§Øª' : 'Summaries'}">Ø§Ù„Ù…Ù„Ø®ØµØ§Øª</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-summary">â–¼</span>
                </div>
                <div class="accordion-content" id="content-summary">
                    <!-- General Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>ğŸ“– <span th:text="${bookLanguage == 'ar' ? 'Ù…Ù„Ø®Øµ Ø¹Ø§Ù…' : 'General Summary'}">Ù…Ù„Ø®Øµ Ø¹Ø§Ù…</span></h4>
                        </div>
                        <form th:action="@{/summary/general}" method="post" onsubmit="handleSubmit(this, 'summaryGeneral')">
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ø®Øµ' : 'Generate Summary'}">ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ø®Øµ</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-summaryGeneral">
                            <div class="chat-message" th:if="${summaryGeneral}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${summaryGeneral}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${summaryGeneral}" th:text="${bookLanguage == 'ar' ? 'Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ø®Øµ' : 'Click button to generate summary'}">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„ØªÙˆÙ„ÙŠØ¯ Ù…Ù„Ø®Øµ</p>
                        </div>
                    </div>

                    <!-- Pages Summary -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>ğŸ“„ <span th:text="${bookLanguage == 'ar' ? 'Ù…Ù„Ø®Øµ ØµÙØ­Ø§Øª Ù…Ø®ØªØ§Ø±Ø©' : 'Selected Pages Summary'}">Ù…Ù„Ø®Øµ ØµÙØ­Ø§Øª Ù…Ø®ØªØ§Ø±Ø©</span></h4>
                        </div>
                        <form th:action="@{/summary/pages}" method="post" onsubmit="handleSubmit(this, 'summaryPages')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ù…Ù† ØµÙØ­Ø©' : 'From Page'}">Ù…Ù† ØµÙØ­Ø©</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ø¥Ù„Ù‰ ØµÙØ­Ø©' : 'To Page'}">Ø¥Ù„Ù‰ ØµÙØ­Ø©</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'ØªÙ„Ø®ÙŠØµ' : 'Summarize'}">ØªÙ„Ø®ÙŠØµ</button>
                        </form>
                        <div class="result-container" id="result-summaryPages">
                            <div class="chat-message" th:if="${summaryPages}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${summaryPages}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${summaryPages}" th:text="${bookLanguage == 'ar' ? 'Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙ„Ø®ÙŠØµ' : 'Enter page range and click Summarize'}">Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙ„Ø®ÙŠØµ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 2: Analysis -->
            <div class="accordion-group" data-group="analysis">
                <div class="accordion-header" onclick="toggleAccordion('analysis')">
                    <div class="accordion-title">
                        <span class="accordion-icon">ğŸ”¬</span>
                        <h3 th:text="${bookLanguage == 'ar' ? 'Ø§Ù„ØªØ­Ù„ÙŠÙ„' : 'Analysis'}">Ø§Ù„ØªØ­Ù„ÙŠÙ„</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-analysis">â–¼</span>
                </div>
                <div class="accordion-content" id="content-analysis">
                    <!-- Reality Check -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>âœ… <span th:text="${bookLanguage == 'ar' ? 'ÙØ­Øµ Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©' : 'Reality Check'}">ÙØ­Øµ Ø§Ù„ÙˆØ§Ù‚Ø¹ÙŠØ©</span></h4>
                        </div>
                        <form th:action="@{/reality-check}" method="post" onsubmit="handleSubmit(this, 'realityCheck')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ù…Ù† ØµÙØ­Ø©' : 'From Page'}">Ù…Ù† ØµÙØ­Ø©</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ø¥Ù„Ù‰ ØµÙØ­Ø©' : 'To Page'}">Ø¥Ù„Ù‰ ØµÙØ­Ø©</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'ÙØ­Øµ' : 'Check'}">ÙØ­Øµ</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-realityCheck">
                            <div class="chat-message" th:if="${realityCheck}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${realityCheck}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${realityCheck}" th:text="${bookLanguage == 'ar' ? 'Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ÙØ­Øµ' : 'Enter page range and click Check'}">Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ÙØ­Øµ</p>
                        </div>
                    </div>

                    <!-- Concept Map -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>ğŸ—ºï¸ <span th:text="${bookLanguage == 'ar' ? 'Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ…' : 'Concept Map'}">Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ…</span></h4>
                        </div>
                        <form th:action="@{/concept-map}" method="post" onsubmit="handleSubmit(this, 'conceptMap')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ù…Ù† ØµÙØ­Ø©' : 'From Page'}">Ù…Ù† ØµÙØ­Ø©</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ø¥Ù„Ù‰ ØµÙØ­Ø©' : 'To Page'}">Ø¥Ù„Ù‰ ØµÙØ­Ø©</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'ØªÙˆÙ„ÙŠØ¯ Ø®Ø±ÙŠØ·Ø©' : 'Generate Map'}">ØªÙˆÙ„ÙŠØ¯ Ø®Ø±ÙŠØ·Ø©</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-conceptMap">
                            <div class="chat-message" th:if="${conceptMap}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${conceptMap}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${conceptMap}" th:text="${bookLanguage == 'ar' ? 'Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯ Ø®Ø±ÙŠØ·Ø©' : 'Enter page range and click Generate Map'}">Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯ Ø®Ø±ÙŠØ·Ø©</p>
                        </div>
                    </div>

                    <!-- Risk Flags -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>âš ï¸ <span th:text="${bookLanguage == 'ar' ? 'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±' : 'Risk Flags'}">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</span></h4>
                        </div>
                        <form th:action="@{/risk-flags}" method="post" onsubmit="handleSubmit(this, 'riskFlags')">
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª' : 'Extract Flags'}">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-riskFlags">
                            <div class="chat-message" th:if="${riskFlags}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${riskFlags}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${riskFlags}" th:text="${bookLanguage == 'ar' ? 'Ø§Ø¶ØºØ· Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±' : 'Click to extract risk flags'}">Ø§Ø¶ØºØ· Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø§Ø·Ø±</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Group 3: Interactive -->
            <div class="accordion-group" data-group="interactive">
                <div class="accordion-header" onclick="toggleAccordion('interactive')">
                    <div class="accordion-title">
                        <span class="accordion-icon">ğŸ’¬</span>
                        <h3 th:text="${bookLanguage == 'ar' ? 'Ø§Ù„ØªÙØ§Ø¹Ù„' : 'Interactive'}">Ø§Ù„ØªÙØ§Ø¹Ù„</h3>
                    </div>
                    <span class="accordion-arrow" id="arrow-interactive">â–¼</span>
                </div>
                <div class="accordion-content" id="content-interactive">
                    <!-- Action Plan -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>ğŸ“‹ <span th:text="${bookLanguage == 'ar' ? 'Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©' : 'Action Plan'}">Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ©</span></h4>
                        </div>
                        <form th:action="@{/action-plan}" method="post" onsubmit="handleSubmit(this, 'actionPlan')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ù…Ù† ØµÙØ­Ø©' : 'From Page'}">Ù…Ù† ØµÙØ­Ø©</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ø¥Ù„Ù‰ ØµÙØ­Ø©' : 'To Page'}">Ø¥Ù„Ù‰ ØµÙØ­Ø©</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø©' : 'Generate Plan'}">ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø©</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-actionPlan">
                            <div class="chat-message" th:if="${actionPlan}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${actionPlan}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${actionPlan}" th:text="${bookLanguage == 'ar' ? 'Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø©' : 'Enter page range and click Generate Plan'}">Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯ Ø®Ø·Ø©</p>
                        </div>
                    </div>

                    <!-- Semantic Search -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>ğŸ” <span th:text="${bookLanguage == 'ar' ? 'Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ' : 'Semantic Search'}">Ø¨Ø­Ø« Ø¯Ù„Ø§Ù„ÙŠ</span></h4>
                        </div>
                        <form th:action="@{/semantic-search}" method="post" onsubmit="handleSubmit(this, 'semanticSearch')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡ØŸ' : 'What are you looking for?'}">Ù…Ø§ Ø§Ù„Ø°ÙŠ ØªØ¨Ø­Ø« Ø¹Ù†Ù‡ØŸ</label>
                                    <input type="text" name="query" required th:placeholder="${bookLanguage == 'ar' ? 'Ø§ÙƒØªØ¨ Ø¨Ø­Ø«Ùƒ Ù‡Ù†Ø§...' : 'Type your search...'}">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'Ø¨Ø­Ø«' : 'Search'}">Ø¨Ø­Ø«</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-semanticSearch">
                            <div class="chat-message" th:if="${semanticSearch}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${semanticSearch}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${semanticSearch}" th:text="${bookLanguage == 'ar' ? 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ§Ø¶ØºØ· Ø¨Ø­Ø«' : 'Type your query and click Search'}">Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ§Ø¶ØºØ· Ø¨Ø­Ø«</p>
                        </div>
                    </div>

                    <!-- Q&A -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>â“ <span th:text="${bookLanguage == 'ar' ? 'Ø³Ø¤Ø§Ù„ ÙˆØ¬ÙˆØ§Ø¨' : 'Question & Answer'}">Ø³Ø¤Ø§Ù„ ÙˆØ¬ÙˆØ§Ø¨</span></h4>
                        </div>
                        <form th:action="@{/qa}" method="post" onsubmit="handleSubmit(this, 'qa')">
                            <div class="form-row">
                                <div class="form-group form-group-full">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ø§Ø³Ø£Ù„ Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨' : 'Ask about the book'}">Ø§Ø³Ø£Ù„ Ù…Ù† Ø§Ù„ÙƒØªØ§Ø¨</label>
                                    <input type="text" name="question" required th:placeholder="${bookLanguage == 'ar' ? 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§...' : 'Type your question...'}">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'Ø¥Ø±Ø³Ø§Ù„' : 'Send'}">Ø¥Ø±Ø³Ø§Ù„</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-qa">
                            <div class="chat-message" th:if="${qa}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${qa}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${qa}" th:text="${bookLanguage == 'ar' ? 'Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„' : 'Type your question and click Send'}">Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ ÙˆØ§Ø¶ØºØ· Ø¥Ø±Ø³Ø§Ù„</p>
                        </div>
                    </div>

                    <!-- Comprehension Test -->
                    <div class="tool-card">
                        <div class="tool-header">
                            <h4>ğŸ“ <span th:text="${bookLanguage == 'ar' ? 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ‡Ù…' : 'Comprehension Test'}">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙÙ‡Ù…</span></h4>
                        </div>
                        <form th:action="@{/comprehension}" method="post" onsubmit="handleSubmit(this, 'comprehension')">
                            <div class="form-row">
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ù…Ù† ØµÙØ­Ø©' : 'From Page'}">Ù…Ù† ØµÙØ­Ø©</label>
                                    <input type="number" name="startPage" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label th:text="${bookLanguage == 'ar' ? 'Ø¥Ù„Ù‰ ØµÙØ­Ø©' : 'To Page'}">Ø¥Ù„Ù‰ ØµÙØ­Ø©</label>
                                    <input type="number" name="endPage" min="1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-tool">
                                <span th:text="${bookLanguage == 'ar' ? 'ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±' : 'Generate Test'}">ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±</span>
                            </button>
                        </form>
                        <div class="result-container" id="result-comprehension">
                            <div class="chat-message" th:if="${comprehension}">
                                <div class="message-content markdown-body"></div>
                                <div class="raw-content" th:text="${comprehension}" style="display: none;"></div>
                            </div>
                            <p class="no-result" th:unless="${comprehension}" th:text="${bookLanguage == 'ar' ? 'Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±' : 'Enter page range and click Generate Test'}">Ø£Ø¯Ø®Ù„ Ù†Ø·Ø§Ù‚ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ø¶ØºØ· ØªÙˆÙ„ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p th:text="${bookLanguage == 'ar' ? 'Book Assistant Lite - Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'Book Assistant Lite - AI Powered'}">Book Assistant Lite - Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
        </div>
    </footer>

    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Highlight.js for syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <script>
        // Configure marked.js
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // Custom renderer for code blocks with copy button
        const renderer = new marked.Renderer();
        renderer.code = function(code, language) {
            const validLang = language || 'plaintext';
            const escapedCode = code.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
            
            return `
<div class="code-block-wrapper">
    <div class="code-block-header">
        <span class="code-language">${validLang}</span>
        <button class="copy-code-btn" onclick="copyCode(this)" title="Copy code">
            <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copy</span>
        </button>
    </div>
    <pre class="code-block"><code class="language-${validLang}">${escapedCode}</code></pre>
</div>`;
        };

        marked.use({ renderer });

        // Copy code function
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const codeText = codeBlock.textContent;
            
            navigator.clipboard.writeText(codeText).then(() => {
                const copyText = button.querySelector('.copy-text');
                const originalText = copyText.textContent;
                copyText.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    copyText.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy:', err);
            });
        }

        // Render markdown in result containers
        function renderMarkdownResults() {
            const resultContainers = document.querySelectorAll('.result-container');
            
            resultContainers.forEach(container => {
                const chatMessage = container.querySelector('.chat-message');
                if (chatMessage) {
                    const messageContent = chatMessage.querySelector('.message-content');
                    const rawContentDiv = chatMessage.querySelector('.raw-content');
                    const rawContent = rawContentDiv ? rawContentDiv.textContent : '';
                    
                    if (rawContent && messageContent) {
                        // Parse markdown and render
                        messageContent.innerHTML = marked.parse(rawContent);
                        
                        // Apply syntax highlighting to any code blocks
                        messageContent.querySelectorAll('pre code').forEach((block) => {
                            hljs.highlightElement(block);
                        });
                    }
                }
            });
        }

        // Accordion toggle function
        function toggleAccordion(group) {
            const content = document.getElementById('content-' + group);
            const arrow = document.getElementById('arrow-' + group);
            const groupEl = document.querySelector('[data-group="' + group + '"]');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.style.transform = 'rotate(0deg)';
                groupEl.classList.remove('active');
            } else {
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                groupEl.classList.add('active');
            }
        }

        // Form submission handler
        function handleSubmit(form, resultId) {
            // Add output language hidden input
            const langSelect = document.getElementById('outputLanguage');
            if (langSelect) {
                let hiddenInput = form.querySelector('input[name="outputLanguage"]');
                if (!hiddenInput) {
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'outputLanguage';
                    form.appendChild(hiddenInput);
                }
                hiddenInput.value = langSelect.value;
            }

            // Show loading state
            const button = form.querySelector('button[type="submit"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<span class="spinner"></span> <span>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</span>';
            button.disabled = true;
            form.classList.add('loading');

            // Reset after timeout
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                form.classList.remove('loading');
            }, 300000);
        }

        // Auto-expand accordion with results on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Render markdown in all result containers
            renderMarkdownResults();
            
            const results = ['summaryGeneral', 'summaryPages', 'realityCheck', 'conceptMap', 'riskFlags', 'actionPlan', 'semanticSearch', 'qa', 'comprehension'];
            
            for (let i = results.length - 1; i >= 0; i--) {
                const resultId = results[i];
                const resultEl = document.getElementById('result-' + resultId);
                if (resultEl) {
                    const chatMessage = resultEl.querySelector('.chat-message');
                    if (chatMessage) {
                        const rawContentDiv = chatMessage.querySelector('.raw-content');
                        const rawContent = rawContentDiv ? rawContentDiv.textContent.trim() : '';
                        
                        if (rawContent) {
                            // Find parent accordion group
                            const toolCard = resultEl.closest('.tool-card');
                            const accordionContent = toolCard.closest('.accordion-content');
                            const accordionGroup = accordionContent.parentElement;

                            // Expand this group
                            const groupId = accordionGroup.dataset.group;
                            const content = document.getElementById('content-' + groupId);
                            const arrow = document.getElementById('arrow-' + groupId);

                            content.classList.add('active');
                            arrow.style.transform = 'rotate(180deg)';
                            accordionGroup.classList.add('active');

                            // Scroll to result
                            setTimeout(() => {
                                resultEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                resultEl.classList.add('highlight');
                            }, 500);

                            break; // Only expand the first (most recent) result
                        }
                    }
                }
            }

            // Default: expand first accordion
            const firstAccordion = document.querySelector('.accordion-group');
            if (firstAccordion) {
                const groupId = firstAccordion.dataset.group;
                const content = document.getElementById('content-' + groupId);
                const arrow = document.getElementById('arrow-' + groupId);
                content.classList.add('active');
                arrow.style.transform = 'rotate(180deg)';
                firstAccordion.classList.add('active');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        if (dropZone && fileInput) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if (files.length) {
                    fileInput.files = files;
                }
            });

            dropZone.addEventListener('click', () => fileInput.click());
        }
    </script>
</body>
</html>
